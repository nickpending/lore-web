---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import RecentActivity from '../components/RecentActivity.tsx';
import ActivityChart from '../components/ActivityChart.tsx';
import { counts, commits, tasks } from '../lib/data';

// Generate daily activity data for the full year (for client-side windowing)
interface DailyData {
  date: string;
  value: number;
  commits: number;
  tasks: number;
}

function getDailyActivityData(
  commitList: { date: string }[],
  taskList: { captured: string }[],
  months: number = 12
): DailyData[] {
  const now = new Date();
  const startDate = new Date(now);
  startDate.setMonth(startDate.getMonth() - months);

  // Create a map of date -> { commits, tasks }
  const dateMap = new Map<string, { commits: number; tasks: number }>();

  // Initialize all dates with 0
  const current = new Date(startDate);
  while (current <= now) {
    const dateStr = current.toISOString().split('T')[0];
    dateMap.set(dateStr, { commits: 0, tasks: 0 });
    current.setDate(current.getDate() + 1);
  }

  // Count commits
  commitList.forEach(commit => {
    const dateStr = commit.date.split('T')[0];
    const entry = dateMap.get(dateStr);
    if (entry) {
      entry.commits++;
    }
  });

  // Count tasks
  taskList.forEach(task => {
    const dateStr = task.captured.split('T')[0];
    const entry = dateMap.get(dateStr);
    if (entry) {
      entry.tasks++;
    }
  });

  // Convert to array sorted by date
  return Array.from(dateMap.entries())
    .sort((a, b) => a[0].localeCompare(b[0]))
    .map(([date, counts]) => ({
      date,
      value: counts.commits + counts.tasks,
      commits: counts.commits,
      tasks: counts.tasks
    }));
}

// Full year of data - chart component will show 3 months at a time with navigation
const chartData = getDailyActivityData(commits, tasks, 12);
---

<DashboardLayout
  title="Dashboard"
  headerTitle="Overview"
  currentPath="/"
  counts={{ commits: counts.commits, projects: counts.projects }}
>
  <!-- Hero Section with Activity Chart -->
  <section class="relative w-full bg-[#020304] border-b border-dark-gray">
    <div class="w-full h-[400px]">
      <ActivityChart client:load data={chartData} height={400} />
    </div>

    <!-- Stat Cards Overlay (positioned at bottom of hero) -->
    <div class="absolute bottom-6 left-6 right-6 flex gap-4">
      <div class="bg-bg-elevated/90 backdrop-blur rounded border border-cyan/30 px-6 py-4 min-w-[140px]">
        <div class="text-3xl font-semibold text-white">{counts.projects}</div>
        <div class="text-xs text-gray mt-1">Projects</div>
      </div>
      <div class="bg-bg-elevated/90 backdrop-blur rounded border border-cyan/30 px-6 py-4 min-w-[140px]">
        <div class="text-3xl font-semibold text-white">{counts.commits}</div>
        <div class="text-xs text-gray mt-1">Commits</div>
      </div>
      <div class="bg-bg-elevated/90 backdrop-blur rounded border border-cyan/30 px-6 py-4 min-w-[140px]">
        <div class="text-3xl font-semibold text-white">{counts.personal}</div>
        <div class="text-xs text-gray mt-1">Personal</div>
      </div>
    </div>
  </section>

  <!-- Two-Column Layout Below Hero -->
  <div class="grid grid-cols-[1fr_1.5fr] gap-6 p-6">
    <!-- Left: Recent Activity -->
    <div class="bg-bg-card border border-dark-gray p-6">
      <h2 class="text-sm font-medium text-white mb-4">Recent activity</h2>
      <RecentActivity client:load commits={commits} tasks={tasks} limit={5} />
    </div>

    <!-- Right: Project Cards (placeholder for Feature 6) -->
    <div class="space-y-4">
      <h2 class="text-sm font-medium text-white">Project cards</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-bg-card border border-dark-gray p-4">
          <div class="text-sm text-gray mb-2">Gain Turquise</div>
          <div class="h-24 bg-bg-elevated rounded flex items-center justify-center text-xs text-dark-gray">
            Chart placeholder
          </div>
        </div>
        <div class="bg-bg-card border border-dark-gray p-4">
          <div class="text-sm text-gray mb-2">Paypalce Series</div>
          <div class="h-24 bg-bg-elevated rounded flex items-center justify-center text-xs text-dark-gray">
            Chart placeholder
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
