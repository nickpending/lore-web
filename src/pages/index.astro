---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import RecentActivity from '../components/RecentActivity.tsx';
import StatPanel from '../components/StatPanel.tsx';
import { ActivityTerrain } from '../components/ActivityTerrain';
import { counts, commits, tasks, terrainGrid, totalEntries } from '../lib/data';

// Generate weekly trends from commits (last 12 weeks)
function getWeeklyTrend(items: { date: string }[], weeks: number = 12): number[] {
  const now = new Date();
  const trend: number[] = [];

  for (let i = weeks - 1; i >= 0; i--) {
    const weekStart = new Date(now);
    weekStart.setDate(weekStart.getDate() - (i * 7) - weekStart.getDay());
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 7);

    const count = items.filter(item => {
      const date = new Date(item.date);
      return date >= weekStart && date < weekEnd;
    }).length;

    trend.push(count);
  }

  return trend;
}

const commitTrend = getWeeklyTrend(commits, 12);
const taskTrend = getWeeklyTrend(tasks.map(t => ({ date: t.captured })), 12);
const activityTrend = commitTrend.map((c, i) => c + (taskTrend[i] || 0));
---

<DashboardLayout
  title="Dashboard"
  headerTitle="Contribution Heat"
  currentPath="/"
  counts={{ commits: counts.commits, projects: counts.projects }}
>
  <!-- Hero Section with Activity Terrain (placeholder for 2D chart) -->
  <section class="relative w-full bg-[#020304] border-b border-dark-gray">
    <div class="w-full h-[400px]">
      <ActivityTerrain client:visible grid={terrainGrid} />
    </div>

    <!-- Stat Cards Overlay (positioned at bottom of hero) -->
    <div class="absolute bottom-6 left-6 right-6 flex gap-4">
      <div class="bg-bg-deep/80 backdrop-blur border border-dark-gray px-6 py-4 min-w-[140px]">
        <div class="text-3xl font-semibold text-white">{counts.projects}</div>
        <div class="text-xs text-gray mt-1">{counts.projects} Projects</div>
      </div>
      <div class="bg-bg-deep/80 backdrop-blur border border-dark-gray px-6 py-4 min-w-[140px]">
        <div class="text-3xl font-semibold text-white">{counts.commits}</div>
        <div class="text-xs text-gray mt-1">Watts / {counts.commits} Commits</div>
      </div>
      <div class="bg-bg-deep/80 backdrop-blur border border-dark-gray px-6 py-4 min-w-[140px]">
        <div class="text-3xl font-semibold text-white">{counts.personal}</div>
        <div class="text-xs text-gray mt-1">Personal / {counts.tasks} Journal</div>
      </div>
    </div>
  </section>

  <!-- Two-Column Layout Below Hero -->
  <div class="grid grid-cols-[1fr_1.5fr] gap-6 p-6">
    <!-- Left: Recent Activity -->
    <div class="bg-bg-card border border-dark-gray p-6">
      <h2 class="text-sm font-medium text-white mb-4">Recent activity</h2>
      <RecentActivity client:load commits={commits} tasks={tasks} limit={5} />
    </div>

    <!-- Right: Project Cards (placeholder for Feature 6) -->
    <div class="space-y-4">
      <h2 class="text-sm font-medium text-white">Project cards</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-bg-card border border-dark-gray p-4">
          <div class="text-sm text-gray mb-2">Gain Turquise</div>
          <div class="h-24 bg-bg-elevated rounded flex items-center justify-center text-xs text-dark-gray">
            Chart placeholder
          </div>
        </div>
        <div class="bg-bg-card border border-dark-gray p-4">
          <div class="text-sm text-gray mb-2">Paypalce Series</div>
          <div class="h-24 bg-bg-elevated rounded flex items-center justify-center text-xs text-dark-gray">
            Chart placeholder
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
