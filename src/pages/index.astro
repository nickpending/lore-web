---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import RecentActivityList from '../components/RecentActivityList.tsx';
import ActivityChart from '../components/ActivityChart.tsx';
import StatPanel from '../components/StatPanel.tsx';
import ProjectActivityCard from '../components/ProjectActivityCard.tsx';
import { counts, commits, tasks, captures, projects, personal, explorations, blogs, getProjectActivityData, getCapturesActivityData, getTasksActivityData } from '../lib/data';

// Generate daily activity data for the full year (for client-side windowing)
interface DailyData {
  date: string;
  value: number;
  commits: number;
  tasks: number;
}

function getDailyActivityData(
  commitList: { date: string }[],
  taskList: { captured: string }[],
  months: number = 12
): DailyData[] {
  const now = new Date();
  const startDate = new Date(now);
  startDate.setMonth(startDate.getMonth() - months);

  // Create a map of date -> { commits, tasks }
  const dateMap = new Map<string, { commits: number; tasks: number }>();

  // Initialize all dates with 0
  const current = new Date(startDate);
  while (current <= now) {
    const dateStr = current.toISOString().split('T')[0];
    dateMap.set(dateStr, { commits: 0, tasks: 0 });
    current.setDate(current.getDate() + 1);
  }

  // Count commits
  commitList.forEach(commit => {
    const dateStr = commit.date.split('T')[0];
    const entry = dateMap.get(dateStr);
    if (entry) {
      entry.commits++;
    }
  });

  // Count tasks
  taskList.forEach(task => {
    const dateStr = task.captured.split('T')[0];
    const entry = dateMap.get(dateStr);
    if (entry) {
      entry.tasks++;
    }
  });

  // Convert to array sorted by date
  return Array.from(dateMap.entries())
    .sort((a, b) => a[0].localeCompare(b[0]))
    .map(([date, counts]) => ({
      date,
      value: counts.commits + counts.tasks,
      commits: counts.commits,
      tasks: counts.tasks
    }));
}

// Full year of data - chart component will show 3 months at a time with navigation
const chartData = getDailyActivityData(commits, tasks, 12);

// Activity data for dashboard cards (12-week window = ~3 months, weekly resolution)
const cardWeeks = 12;
const topProjects = getProjectActivityData(2, cardWeeks);
const capturesActivity = getCapturesActivityData(cardWeeks);
const tasksActivity = getTasksActivityData(cardWeeks);
---

<DashboardLayout
  title="Dashboard"
  headerTitle="Overview"
  currentPath="/"
  counts={{ commits: counts.commits, projects: counts.projects }}
>
  <!-- Hero Section with Activity Chart -->
  <section class="relative w-full bg-[#020304] border-b border-dark-gray">
    <div class="w-full h-[400px]">
      <ActivityChart client:load data={chartData} height={400} />
    </div>

    <!-- Stat Cards Overlay (positioned at bottom of hero) -->
    <div class="absolute bottom-6 left-6 right-6 flex gap-4">
      <StatPanel variant="overlay" title="Projects" value={counts.projects} />
      <StatPanel variant="overlay" title="Commits" value={counts.commits} />
      <StatPanel variant="overlay" title="Personal" value={counts.personal} />
    </div>
  </section>

  <!-- Two-Column Layout Below Hero -->
  <div class="grid grid-cols-[1fr_1.5fr] gap-6 p-6">
    <!-- Left: Recent Activity -->
    <div class="bg-bg-card border border-dark-gray p-6 rounded">
      <RecentActivityList
        client:load
        commits={commits}
        tasks={tasks}
        captures={captures}
        projects={projects}
        personal={personal}
        explorations={explorations}
        blogs={blogs}
        limit={8}
      />
    </div>

    <!-- Right: Activity Cards -->
    <div class="space-y-4">
      <h2 class="text-sm font-medium text-white">Activity Trends</h2>
      <div class="grid grid-cols-2 gap-4">
        {/* Top 2 projects */}
        {topProjects.map((project) => (
          <ProjectActivityCard
            client:load
            label={project.projectName}
            data={project.data}
            weekDates={project.weekDates}
            total={project.totalCommits}
            unit="commits"
          />
        ))}
        {/* Captures */}
        <ProjectActivityCard
          client:load
          label={capturesActivity.label}
          data={capturesActivity.data}
          weekDates={capturesActivity.weekDates}
          total={capturesActivity.total}
          unit="captured"
          color="#9F4DFF"
        />
        {/* Tasks */}
        <ProjectActivityCard
          client:load
          label={tasksActivity.label}
          data={tasksActivity.data}
          weekDates={tasksActivity.weekDates}
          total={tasksActivity.total}
          unit="tracked"
          color="#00D9FF"
        />
      </div>
    </div>
  </div>
</DashboardLayout>
